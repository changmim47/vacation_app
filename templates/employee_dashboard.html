<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>직원 휴가 대시보드</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .container { display: flex; height: 100vh; }
    .sidebar {
      width: 320px;
      background-color: #fff;
      padding: 30px 20px;
      border-right: 1px solid #dee2e6;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.03);
      overflow-y: auto;
    }
    .main { flex: 1; padding: 1px 90px; }
    .header {
      font-size: 20px;
      margin-bottom: 20px;
      font-weight: bold;
      color: #343a40;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logout-btn {
      font-size: 13px;
      background-color: transparent;
      color: #007bff;
      border: none;
      cursor: pointer;
    }
    .logout-btn:hover { 
      text-decoration: underline; 
    }
    
    h3 {
      margin-top: 10px;
      font-size: 16px;
      color: #007bff;
    }
    label {
      font-size: 14px;
      font-weight: 500;
      display: block;
      margin-top: 15px;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    button {
      width: 100%;
      padding: 10px;
      margin-top: 20px;
      background-color: #007bff;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
    }
    button:hover { 
      background-color: #0056b3; 
    }

  .tab-buttons {
    display: flex !important;            /* 가로 정렬 */
    gap: 6px;                   /* 버튼 간격 */
    margin: 15px 0 10px;
  }

  .tab-btn {
    padding: 6px 14px;
    border: none;
    border-radius: 20px;
    background-color: #dee2e6;
    cursor: pointer;
    font-size: 13px;
    font-weight: bold;
    white-space: nowrap;       /* 버튼 안 줄바꿈 방지 */
  }

    .tab-btn.active { background-color: #007bff; color: white; }
    .vacation-item {
      background: #f8f9fa;
      border-left: 4px solid #007bff;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .calendar-header h3 {
      font-size: 18px;
      color: #007bff;
      margin-top: 20px;
      margin-bottom: 10px;
    }
    #calendar {
      max-width: 100%;
      height: 750px;
    }

    .fc .fc-daygrid-day { min-height: 120px; }
    .fc .fc-daygrid-day-number {
      font-size: 16px;
      padding: 6px;
    }
    .fc .fc-daygrid-event {
      font-size: 13px;
      padding: 2px 4px;
    }
    .fc .fc-toolbar-title { font-size: 20px; }
    .fc .fc-button {
      padding: 5px 12px;
      font-size: 13px;
      height: auto;
      border-radius: 20px;
      border: 1px solid #ced4da;
      background-color: #fff;
      color: #495057;
    }
    .fc .fc-button-primary:not(:disabled).fc-button-active,
    .fc .fc-button-primary:not(:disabled):active {
      background-color: #007bff;
      color: #fff;
    }
    .box {
      background-color: #ffffff;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 0px 10px 10px 10px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    .fc-header-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: nowrap;
    }
    .fc-header-toolbar .fc-toolbar-chunk {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tag {
      display: inline-block;
      background-color: #e8f0fe;
      color: #495057;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-right: 6px;
    }

    .name {
      font-weight: bold;
      font-size: 14px;
      color: #343a40;
    }

    .date {
      font-size: 14px;
      vertical-align: middle;
      color: #918f8f;
      font-weight: 500;
    }

    .vacation-annual { background-color: #f36c77; border: none; }
    .vacation-monthly { background-color: #f36c77; border: none; }
    .vacation-half-am { background-color: #61d0fc; border: none; }
    .vacation-half-am { background-color: #61d0fc; border: none; }
    .vacation-quarter-am { background-color: #346ad4; border: none; }
    .vacation-quarter-pm { background-color: #346ad4; border: none; }

  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <div class="header">
        {{ user.name }}님, 환영합니다!
        <a href="/logout" class="logout-btn">로그아웃</a>
      </div>

      <div class="box">
        <h3>📊 연차 정보</h3>
        <p>연차: {{ yearly_leave }}일</p>
        <p>월차: {{ monthly_leave }}일</p>
        <p>총 잔여 일수: {{ remaining_total }}일</p>
      </div>

      <div class="box">
        <h3>📅 휴가 신청</h3>
        <form method="POST" action="/request-vacation">
          <label>시작일:</label>
          <input type="date" name="start_date" required>
          <label>종료일:</label>
          <input type="date" name="end_date" required>
          <label>휴가 종류:</label>
          <select name="type" required>
            <option value="연차">연차</option>
            <option value="월차">월차</option>
            <option value="반차-오전">반차 - 오전</option>
            <option value="반차-오후">반차 - 오후</option>
            <option value="반반차-오전">반반차 - 오전</option>
            <option value="반반차-오후">반반차 - 오후</option>
          </select>
          <button type="submit">신청하기</button>
        </form>
      </div>

      <div class="box">
        <h3>📌 신청 내역</h3>
        <div class="tab-buttons">
          <button class="tab-btn" data-status="대기중" id="default-tab">대기중 ({{ pending_count }})</button>
          <button class="tab-btn" data-status="승인됨">승인됨 ({{ approved_count }})</button>
          <button class="tab-btn" data-status="반려됨">반려됨 ({{ rejected_count }})</button>
        </div>
        <div id="vacation-list"></div>
      </div>
    </div>

    <div class="main">
      <div class="calendar-header">
        <h3>📆 휴가 캘린더</h3>
      </div>
      <div id="calendar"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const calendarEl = document.getElementById('calendar');
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        height: 1000,
        headerToolbar: {
          left: 'today prev,next',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        events: function(fetchInfo, successCallback, failureCallback) {
          const year = fetchInfo.start.getFullYear();
          const holidayUrl = `/static/holidays/${year}holidays.json`;

          Promise.all([
            fetch('/vacation-events').then(res => res.json()),
            fetch(holidayUrl).then(res => res.json()).catch(() => [])
          ])
          .then(([vacationEvents, holidayEvents]) => {
            successCallback([...vacationEvents, ...holidayEvents]);
          })
          .catch(error => {
            console.error('이벤트 로딩 실패:', error);
            failureCallback(error);
          });
        },
        dayCellDidMount: function(info) {
          const day = info.date.getDay();
          const numberEl = info.el.querySelector('.fc-daygrid-day-number');
          if (numberEl) {
            if (day === 0) numberEl.style.color = 'red';
            else if (day === 6) numberEl.style.color = 'blue';
          }
        }
      });

      calendar.render();
    });
  </script>

  <script>
  const allVacations = {{ vacations | tojson }};
  const vacationList = document.getElementById('vacation-list');
  let currentStatus = null;

  function renderVacations(status) {
    if (currentStatus === status) {
      vacationList.innerHTML = '';
      currentStatus = null;
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      return;
    }

    currentStatus = status;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    const activeBtn = document.querySelector(`.tab-btn[data-status="${status}"]`);
    if (activeBtn) activeBtn.classList.add('active');

    let filtered = status === 'all'
      ? allVacations
      : allVacations.filter(v => v.status_kor === status);

    vacationList.innerHTML = filtered.length === 0
      ? '<p style="font-size:14px; color:gray;">휴가 내역이 없습니다.</p>'
      : filtered.map(v => `
      <div class="vacation-item">
        <span class="tag">${v.type}</span>
        <span class="name">${v.name}</span><br>
        <span class="date">${v.start_date}</span> ~ 
        <span class="date">${v.end_date}</span>
      </div>
`).join('');
  }

  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      renderVacations(btn.dataset.status);
    });
  });

  vacationList.innerHTML = '';
  renderVacations('대기중');  // ✅ 페이지 로딩 시 대기중 탭 기본 활성화
</script>
<script>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        alert("{{ message }}");
      {% endfor %}
    {% endif %}
  {% endwith %}
</script>
</body>
</html>
