{% extends "base.html" %}

{% block title %}íœ´ê°€ í˜„í™© | ì§ì› ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block head_extras %}
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    <style>
        .fc-toolbar-title {
            font-weight: 700;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="dynamic-content-area">
        <h4>ğŸ“… íœ´ê°€ í˜„í™©</h4>
        <div id="calendar"></div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
      const calendarEl = document.getElementById('calendar');
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        height: '85vh', // ìº˜ë¦°ë” ë†’ì´ë¥¼ í™”ë©´ ë†’ì´ì˜ 80%ë¡œ ì„¤ì •
        headerToolbar: {
          left: 'today prev,next',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        // âœ… ê³µíœ´ì¼ ë° íœ´ê°€ ì´ë²¤íŠ¸ ë¡œë”©
        events: function(fetchInfo, successCallback, failureCallback) {
          const year = fetchInfo.start.getFullYear();
          const holidayUrl = `/static/holidays/${year}holidays.json`;

          Promise.all([
            fetch('/vacation-events').then(res => res.json()),
            fetch(holidayUrl).then(res => res.json()).catch(() => [])
          ])
          .then(([vacationEvents, holidayData]) => {
            const holidays = holidayData.map(h => ({
              title: h.title,
              start: h.start, // JSON ë°ì´í„°ì˜ 'start' í•„ë“œë¥¼ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •
              color: 'red',
              allDay: true
            }));
            successCallback([...vacationEvents, ...holidays]);
          })
          .catch(error => {
            console.error('ì´ë²¤íŠ¸ ë¡œë”© ì‹¤íŒ¨:', error);
            failureCallback(error);
          });
        },
        // âœ… ì£¼ë§ ìƒ‰ìƒ ì„¤ì •
        dayCellDidMount: function(info) {
          const day = info.date.getDay();
          const numberEl = info.el.querySelector('.fc-daygrid-day-number');
          if (numberEl) {
            if (day === 0) numberEl.style.color = 'red';
            else if (day === 6) numberEl.style.color = 'blue';
          }
        },
        eventDidMount: function(info) {
          const holidayTitle = info.event.title;
          const holidayStart = info.event.startStr;
          
          if (info.el.classList.contains('fc-event-full')) {
            const dayEl = document.querySelector(`.fc-day[data-date="${holidayStart}"]`);
            if (dayEl) {
              const holidayText = dayEl.querySelector('.fc-daygrid-day-bottom');
              if (holidayText) {
                // ì´ë¯¸ ê³µíœ´ì¼ì´ í‘œì‹œë˜ì–´ ìˆë‹¤ë©´ ì¤‘ë³µ ë°©ì§€
                if (!holidayText.querySelector('.holiday-text')) {
                  const span = document.createElement('span');
                  span.className = 'holiday-text';
                  span.style.fontSize = '0.7em';
                  span.style.color = 'red';
                  span.style.marginLeft = '5px';
                  span.textContent = holidayTitle;
                  holidayText.appendChild(span);
                }
              }
            }
          }
        }
      });

      calendar.render();
    });
    </script>
{% endblock %}