{% extends "base.html" %}

{% block title %}ê³µì§€ì‚¬í•­{% endblock %}

{% block head_extras %}

{% endblock %}

{% block content %}
<div class="notice-main-container">
    <div class="notice-grid">

        <!-- ê³µì§€ì‚¬í•­ ëª©ë¡ (ì™¼ìª½ íŒ¨ë„) -->
        <div class="notice-card" id="notices-list-card">
            <div class="notice-card-header">
                <h5><i class="material-icons-outlined">campaign</i> ê³µì§€ì‚¬í•­</h5>
                <span id="notice-count">ì´ 0ê±´</span>
            </div>
            
            <div class="notice-card-body">
                <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
                <div id="loading" class="loading-indicator">
                    <div class="spinner"></div>
                    <p class="mt-2">ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
                
                <!-- ê³µì§€ì‚¬í•­ í…Œì´ë¸” -->
                <div class="notices-table-wrapper" style="max-height: 500px; overflow-y: auto;">
                    <table class="notice-table-container">
                        <thead>
                            <tr>
                                <th style="width: 15%;">No.</th>
                                <th style="width: 55%;">ì œëª©</th>
                                <th style="width: 30%;">ì‘ì„±ì¼ì</th>
                            </tr>
                        </thead>
                        <tbody id="notices-table-body">
                            <!-- JavaScriptë¡œ ê³µì§€ì‚¬í•­ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ê³µì§€ì‚¬í•­ ìƒì„¸ (ì˜¤ë¥¸ìª½ íŒ¨ë„) -->
        <!-- âœ… ì—¬ê¸°ì— ì§€ê¸ˆ ë„ˆê°€ ë³´ì—¬ì¤€ íŒ¨ë„ì„ ë¶™ì—¬ ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤ -->
        <!-- ğŸ”½ ë¶™ì—¬ë„£ê¸° ì‹œì‘ -->
        <div class="notice-card" id="notice-detail-card" style="display: none;">
            <div class="notice-card-header">
                <h5><i class="material-icons-outlined">article</i> ê³µì§€ì‚¬í•­ ìƒì„¸</h5>
            </div>
            <div class="notice-card-body">
                <div id="initial-message" class="initial-message">
                    <p>ì™¼ìª½ ëª©ë¡ì—ì„œ ê³µì§€ì‚¬í•­ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                </div>
                
                <div id="notice-content-wrapper" style="display: none;">
                    <div class="notice-detail-info">
                        <div><span class="notice-info-label">ì‘ì„±ì:</span> <span id="detail-author"></span></div>
                        <div><span class="notice-info-label">ì‘ì„±ì¼:</span> <span id="detail-date"></span></div>
                    </div>
                    
                    <h4 class="notice-detail-title" id="detail-title"></h4>
                    <div id="detail-content" class="notice-detail-content">
                        <!-- JavaScriptë¡œ ê³µì§€ì‚¬í•­ ë‚´ìš©ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                    
                    <div id="detail-attachments" class="notice-attachments" style="display: none;">
                        <h5 class="notice-attachments-title">ì²¨ë¶€íŒŒì¼</h5>
                        <ul id="attachment-list" class="attachment-list">
                            <!-- ì²¨ë¶€íŒŒì¼ ë§í¬ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const noticesListCard = document.getElementById('notices-list-card');
        const noticesTableBody = noticesListCard.querySelector('#notices-table-body');
        const loadingIndicator = noticesListCard.querySelector('#loading');
        const noticeDetailCard = document.getElementById('notice-detail-card');
        const noticeCountSpan = noticesListCard.querySelector('#notice-count');
        const initialMessage = document.getElementById('initial-message');
        const noticeContentWrapper = document.getElementById('notice-content-wrapper');

        let allNotices = [];
        let activeRow = null;

        function formatKoreanDate(dateString) {
            try {
                const dateObj = new Date(dateString);
                if (isNaN(dateObj.getTime())) throw new Error('Invalid date');
                return `${dateObj.getFullYear()}. ${dateObj.getMonth() + 1}. ${dateObj.getDate()}.`;
            } catch (e) {
                console.error('Invalid date format:', dateString, e);
                return 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
            }
        }

        async function fetchNotices() {
            try {
                const response = await fetch('/api/notices');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                allNotices = await response.json();
                loadingIndicator.style.display = 'none';

                if (allNotices.length === 0) {
                    noticesTableBody.innerHTML = `<tr><td colspan="3"><div class="empty-message">ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div></td></tr>`;
                    noticeCountSpan.textContent = `ì´ 0ê±´`;
                    initialMessage.style.display = 'flex';
                    noticeContentWrapper.style.display = 'none';
                    noticeDetailCard.style.display = 'flex';
                    return;
                }

                renderNoticeTable(allNotices);
                noticeCountSpan.textContent = `ì´ ${allNotices.length}ê±´`;
                noticeDetailCard.style.display = 'flex';

                // ğŸ”½ URL íŒŒë¼ë¯¸í„°ì—ì„œ notice_id ê°€ì ¸ì˜¤ê¸°
                const params = new URLSearchParams(window.location.search);
                const targetId = params.get('notice_id');

                let targetRow = null;

                if (targetId) {
                    // ID ì¼ì¹˜í•˜ëŠ” ê³µì§€ì‚¬í•­ ì°¾ê¸°
                    const targetNotice = allNotices.find(n => String(n.id) === targetId);
                    if (targetNotice) {
                        // ì¼ì¹˜í•˜ëŠ” tr ì°¾ì•„ì„œ í´ë¦­í•˜ê¸°
                        const rows = noticesTableBody.querySelectorAll('tr');
                        rows.forEach((tr, i) => {
                            if (allNotices[i].id == targetId) {
                                targetRow = tr;
                            }
                        });

                        if (targetRow) {
                            showNoticeDetails(targetNotice, targetRow);
                            return;
                        }
                    }
                }

                // ê¸°ë³¸: ì²« ë²ˆì§¸ í–‰ ì„ íƒ
                if (noticesTableBody.firstChild) {
                    noticesTableBody.firstChild.click();
                }

            } catch (error) {
                console.error('Error fetching notices:', error);
                loadingIndicator.style.display = 'none';
                noticesTableBody.innerHTML = `<tr><td colspan="3"><div class="error-message">ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div></td></tr>`;
                noticeDetailCard.style.display = 'flex';
                initialMessage.style.display = 'none';
                noticeContentWrapper.style.display = 'none';
            }
        }

        function renderNoticeTable(notices) {
            noticesTableBody.innerHTML = '';
            notices.forEach((notice, index) => {
                const row = document.createElement('tr');
                row.onclick = () => {
                history.pushState(null, '', `?notice_id=${notice.id}`);
                showNoticeDetails(notice, row);
            };

                const formattedDate = formatKoreanDate(notice.created_at);
                row.innerHTML = `
                    <td>${notices.length - index}</td>
                    <td>${notice.title || 'ì œëª© ì—†ìŒ'}</td>
                    <td>${formattedDate}</td>
                `;
                noticesTableBody.appendChild(row);
            });
        }

        function showNoticeDetails(notice, row) {
            if (activeRow) activeRow.classList.remove('is-active');
            row.classList.add('is-active');
            activeRow = row;

            initialMessage.style.display = 'none';
            noticeContentWrapper.style.display = 'block';

            const formattedDate = formatKoreanDate(notice.created_at);

            document.getElementById('detail-author').textContent = notice.author || 'ê´€ë¦¬ì';
            document.getElementById('detail-date').textContent = formattedDate;
            document.getElementById('detail-title').textContent = notice.title || 'ì œëª© ì—†ìŒ';
            document.getElementById('detail-content').innerHTML = notice.content || 'ë‚´ìš© ì—†ìŒ';

            const attachmentsContainer = document.getElementById('detail-attachments');
            const attachmentsList = document.getElementById('attachment-list');
            attachmentsList.innerHTML = '';

            if (notice.attachments && notice.attachments.length > 0) {
                attachmentsContainer.style.display = 'block';
                notice.attachments.forEach(attachment => {
                    const listItem = document.createElement('li');
                    const fileName = attachment.split('/').pop().split('?')[0];
                    listItem.innerHTML = `<a href="${attachment}" target="_blank">${decodeURIComponent(fileName)}</a>`;
                    attachmentsList.appendChild(listItem);
                });
            } else {
                attachmentsContainer.style.display = 'none';
            }
        }

        fetchNotices();
    });
</script>
{% endblock %}
