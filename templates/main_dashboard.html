{% extends "base.html" %}

{% block title %}í•™ìŠµì§€ì›íŒ€HR{% endblock %}

{% block content %}
<div class="main-dashboard-container">
    <h4>My ì˜¤í”¼ìŠ¤</h4>
    
    <div class="dashboard-grid">
        <div class="card">
            <div class="card-header">
                <h5><i class="material-icons-outlined">beach_access</i>ë¶€ì„œ íœ´ê°€ í˜„í™©</h5>
                <a href="{{ url_for('vacation_calendar') }}">ë”ë³´ê¸° ></a>
            </div>
            <div class="card-body">
                <!-- ì—¬ê¸°ì— JavaScriptë¡œ íœ´ê°€ ì •ë³´ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤ -->
                <div id="vacation-list-container" class="vacation-list">
                    <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-group">
            <div class="card leave-status">
                <div class="card-header">
                    <h5><i class="material-icons-outlined">calendar_today</i> ì—°ì°¨ í˜„í™©</h5>
                </div>
                <div class="leave-summary">
                    <div class="leave-item">
                        <span>ë¶€ì—¬</span>
                        <strong>{{ user.yearly_leave + user.monthly_leave | default(0) }}<small> ì¼</small></strong>
                    </div>
                    <div class="leave-item">
                        <span>ì‚¬ìš©</span>
                        <strong>{{ user.total_used_days | default(0) }}<small> ì¼</small></strong>
                    </div>
                    <div class="leave-item">
                        <span>ì”ì—¬</span>
                        <strong>{{ user.remaining_total | default(0) }}<small> ì¼</small></strong>
                    </div>
                </div>
            </div>

            <div class="card application-status">
                <div class="card-header">
                    <h5><i class="material-icons-outlined">airplane_ticket</i> ì‹ ì²­ ë‚´ì—­</h5>
                    <a href="javascript:void(0);" onclick="openVacationModal()">ë”ë³´ê¸° ></a>
                </div>
                <div class="application-counts">
                    <div class="application-item pending">
                        <small>ëŒ€ê¸°ì¤‘</small>
                        <strong>{{ pending_count | default(0) }}</strong>
                    </div>
                    <div class="application-item approved">
                        <small>ìŠ¹ì¸ë¨</small>
                        <strong>{{ approved_count | default(0) }}</strong>
                    </div>
                    <div class="application-item rejected">
                        <small>ë°˜ë ¤ë¨</small>
                        <strong>{{ rejected_count | default(0) }}</strong>
                    </div>
                </div>
                {% if pending_count == 0 and approved_count == 0 and rejected_count == 0 %}
                    <p class="no-vacation">íœ´ê°€ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}
            </div>
        </div>

        <div id="vacationModal" class="modal-overlay" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>ğŸ“‹ ë‚˜ì˜ íœ´ê°€ ì‹ ì²­ ë‚´ì—­</h5>
                    <span class="close-btn" onclick="closeModal()">x</span>
                </div>
                <div class="modal-body">
                    <table class="vacation-table">
                        <thead>
                            <tr>
                                <th>ì‹ ì²­ì¼ì</th>
                                <th>íœ´ê°€ìœ í˜•</th>
                                <th>íœ´ê°€ì¢…ë¥˜</th>
                                <th>ì‚¬ìš©ì¼ìˆ˜</th>
                                <th>ì‹œì‘ì¼ì</th>
                                <th>ì¢…ë£Œì¼ì</th>
                                <th>ìŠ¹ì¸ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody id="vacationTableBody">
                            <tr><td colspan="7" style="text-align:center;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

            <div class="card">
                <div class="card-header">
                    <h5><i class="material-icons-outlined">campaign</i> ê³µì§€ì‚¬í•­</h5>
                    <a href="{{ url_for('notices_page') }}">ë”ë³´ê¸° ></a>
                </div>
                <div class="card-body">
                    <ul id="main-dashboard-notices-list" class="list-group list-group-flush">
                        <!-- ê³µì§€ì‚¬í•­ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                        <li class="list-group-item text-center text-muted py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </li>
                    </ul>
                </div>
            </div>
        
        <div class="card my-attendance-status">
            <div class="card-header">
                <h5><i class="material-icons-outlined">schedule</i>MY ê·¼ë¬´ í˜„í™©</h5>
                <a href="{{ url_for('my_attendance') }}">ë”ë³´ê¸° ></a>
            </div>
            <div class="card-body">
                <div class="attendance-info">
                    <span>ì¶œê·¼:</span>
                    <strong class="check-in-time">{{ current_check_in_time | default('ì¶œê·¼ì „') }}</strong>
                </div>
                <div class="attendance-info">
                    <span>í‡´ê·¼:</span>
                    <strong class="check-out-time">{{ current_check_out_time | default('None') }}</strong>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('vacation-list-container');
        const today = new Date();
        today.setHours(0, 0, 0, 0); // ì˜¤ëŠ˜ ë‚ ì§œë§Œ ë¹„êµí•˜ê¸° ìœ„í•´ ì‹œê°„ ì´ˆê¸°í™”

        fetch('{{ url_for("get_vacation_events") }}')
            .then(response => {
                if (!response.ok) {
                    throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
                return response.json();
            })
            .then(events => {
                // ìŠ¹ì¸ëœ(approved) íœ´ê°€ ì´ë²¤íŠ¸ë§Œ í•„í„°ë§
                const approvedVacations = events.filter(event => 
                    event.classNames.includes('vacation-status-approved')
                );
                
                // ì˜¤ëŠ˜ ë‚ ì§œ ì´í›„ì— ì‹œì‘í•˜ëŠ” íœ´ê°€ë§Œ í•„í„°ë§
                const futureVacations = approvedVacations.filter(event => {
                    const startDate = new Date(event.start);
                    startDate.setHours(0, 0, 0, 0); // ë‚ ì§œë§Œ ë¹„êµí•˜ê¸° ìœ„í•´ ì‹œê°„ ì´ˆê¸°í™”
                    return startDate >= today;
                });

                // ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
                container.innerHTML = '';

                if (futureVacations.length > 0) {
                    // íœ´ê°€ ë¦¬ìŠ¤íŠ¸ë¥¼ ì‹œì‘ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
                    futureVacations.sort((a, b) => new Date(a.start) - new Date(b.start));

                    futureVacations.forEach(vacation => {
                        // FullCalendarì˜ end ë‚ ì§œëŠ” ì¢…ë£Œì¼ ë‹¤ìŒ ë‚ ì´ë¯€ë¡œ, í•˜ë£¨ë¥¼ ë¹¼ì„œ í‘œì‹œ
                        const endDate = new Date(vacation.end);
                        endDate.setDate(endDate.getDate() - 1);
                        
                        // ì œëª©ì—ì„œ ì´ë¦„ê³¼ íœ´ê°€ ì¢…ë¥˜ ë¶„ë¦¬
                        const titleParts = vacation.title.match(/(.*) \((.*)\)/);
                        const employeeName = titleParts ? titleParts[1].trim() : 'ì´ë¦„ ì—†ìŒ';
                        const vacationType = titleParts ? titleParts[2].trim() : 'íœ´ê°€';
                        
                        // íœ´ê°€ ê¸°ê°„ ë° ì‚¬ìš© ì¼ìˆ˜ ê³„ì‚°
                        const startDate = new Date(vacation.start);
                        const usedDays = (endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24) + 1;

                        const vacationItem = document.createElement('div');
                        vacationItem.className = 'vacation-item';

                        vacationItem.innerHTML = `
                            <div class="vacation-item-content">
                                <div class="vacation-title">
                                    <span class="tag">${vacationType}</span> <span class="name">${employeeName}</span>
                                </div>
                                <div class="vacation-dates">
                                    ${vacation.start} ~ ${endDate.toISOString().substring(0, 10)} (${usedDays}ì¼)
                                </div>
                            </div>
                            <span class="vacation-status status-approved">ìŠ¹ì¸ë¨</span>
                        `;
                        container.appendChild(vacationItem);
                    });
                } else {
                    container.innerHTML = '<p class="no-vacations-message">í˜„ì¬ ìŠ¹ì¸ëœ íœ´ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            })
            .catch(error => {
                console.error('íœ´ê°€ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                container.innerHTML = '<p class="no-vacations-message">íœ´ê°€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            });
    });

    function openVacationModal() {
        document.getElementById('vacationModal').style.display = 'flex';

        fetch('/my-vacations-history')
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('vacationTableBody');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">íœ´ê°€ ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                data.forEach(v => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${v.requested_at ? v.requested_at.slice(0, 10) : '-'}</td>
                        <td>${v.deduct_from_type === 'yearly' ? 'ì—°ì°¨' : (v.deduct_from_type === 'monthly' ? 'ì›”ì°¨' : 'ê¸°íƒ€')}</td>
                        <td>${v.type_kor || '-'}</td>
                        <td>${v.used_days || 0}ì¼</td>
                        <td>${v.start_date || '-'}</td>
                        <td>${v.end_date || '-'}</td>
                        <td>${statusToKor(v.status)}</td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .catch(() => {
                document.getElementById('vacationTableBody').innerHTML = '<tr><td colspan="7" style="text-align:center;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</td></tr>';
            });
    }

    function closeModal() {
        document.getElementById('vacationModal').style.display = 'none';
    }

    function statusToKor(status) {
        if (status === 'pending') return 'ëŒ€ê¸°ì¤‘';
        if (status === 'approved') return 'ìŠ¹ì¸ë¨';
        if (status === 'rejected') return 'ë°˜ë ¤ë¨';
        return '-';
    }

                {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    alert("{{ message }}");
                {% endfor %}
            {% endif %}
        {% endwith %}

    document.addEventListener("DOMContentLoaded", function() {
        const noticesList = document.getElementById('main-dashboard-notices-list');

        // ë‚ ì§œ í¬ë§· í•¨ìˆ˜ (YYYY-MM-DD í˜•ì‹)
        function formatDate(dateString) {
            try {
                const dateObj = new Date(dateString);
                if (isNaN(dateObj.getTime())) {
                    throw new Error('Invalid date');
                }
                const year = dateObj.getFullYear();
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) {
                console.error('Invalid date format:', dateString, e);
                return 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
            }
        }

        async function fetchDashboardNotices() {
            try {
                const response = await fetch('/api/notices');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const allNotices = await response.json();
                
                noticesList.innerHTML = '';
                
                if (allNotices.length === 0) {
                    noticesList.innerHTML = `<li class="list-group-item text-center text-muted py-3">ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</li>`;
                } else {
                    const recentNotices = allNotices.slice(0, 3);
                    recentNotices.forEach(notice => {
                        const formattedDate = formatDate(notice.created_at);
                        const listItem = document.createElement('li');
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-center py-2 px-0 border-0';
                        
                        // JavaScriptë¥¼ ì‚¬ìš©í•˜ì—¬ URLì„ ì§ì ‘ ìƒì„±í•˜ì—¬ ì˜¤ë¥˜ ë°©ì§€
                        const noticeUrl = `/notices?notice_id=${notice.id}`;
                        
                        listItem.innerHTML = `
                        <div class="notice-left d-flex align-items-center text-truncate">
                            <span class="badge bg-primary me-2">ê³µì§€</span>
                            <a href="${noticeUrl}" class="notice-title text-decoration-none text-dark text-truncate" style="max-width: 100%;">
                                ${notice.title}
                            </a>
                        </div>
                        <small class="text-muted flex-shrink-0 ms-3">${formattedDate}</small>
                        `;
                        noticesList.appendChild(listItem);
                    });
                }
            } catch (error) {
                console.error('Error fetching notices:', error);
                noticesList.innerHTML = `<li class="list-group-item text-center text-danger py-3">ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</li>`;
            }
        }

        fetchDashboardNotices();
    });

</script>
{% endblock %}
